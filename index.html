<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Hand Music ‚Äî Dedos independientes + Auto-silencio</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Tone.js (fallbacks) -->
<script>
(function loadTone(){
  const urls=[
    'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js',
    'https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js',
    'https://unpkg.com/tone@14.8.49/build/Tone.min.js'
  ];
  (function tryOne(i){
    if(i>=urls.length){console.error('Tone.js no carg√≥');return;}
    const s=document.createElement('script'); s.src=urls[i];
    s.onload=()=>console.log('Tone OK:',urls[i]);
    s.onerror=()=>tryOne(i+1);
    document.head.appendChild(s);
  })(0);
})();
</script>

<style>
:root{
  --bg:#0b0f14; --panel:#101722; --ink:#e6f0ff; --muted:#9fb3c8; --accent:#3d7eff;
  --ok:#34d399; --warn:#fbbf24; --danger:#ff5f5f; --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.35);
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
.app{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
.panel{background:var(--panel);border:1px solid #1e2a3e;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
h1{margin:0 0 10px;font-size:20px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
select,button,input[type="range"]{width:100%;padding:10px;border-radius:12px;border:1px solid #233047;background:#0f1725;color:var(--ink)}
.legend{font-size:12px;color:var(--muted)}
.metrics{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
.metric{background:#0e1522;border:1px solid #1e2a3e;border-radius:12px;padding:8px 10px}
.metric b{display:block;font-size:11px;color:var(--muted)}
.metric span{font-size:16px}
.overlay{position:relative;background:#000;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);height:70vh;min-height:420px}
video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)} /* espejo visual */
canvas#cv{position:absolute;inset:0;transform:scaleX(-1)} /* espejo tambi√©n overlay para alinear */
.banner{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#142136;border:1px solid #203050;padding:10px 14px;border-radius:10px;display:none;z-index:9999}
.banner.show{display:block}
kbd{background:#0e1522;border:1px solid #1e2a3e;border-radius:6px;padding:2px 6px;color:#b9c7da}
</style>
</head>
<body>
<div id="banner" class="banner"></div>

<div class="app">
  <div class="panel">
    <h1>Hand Music <span class="legend">‚Äî dedos por separado + auto-silencio</span></h1>

    <div class="row" role="tablist">
      <button id="btnPiano">üéπ Piano (1)</button>
      <button id="btnViolin">üéª Viol√≠n (2)</button>
      <button id="btnSynth">üéõÔ∏è Synth (3)</button>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="scaleSel">
        <option value="free">Libre</option>
        <option value="major" selected>Mayor</option>
        <option value="minor">Menor</option>
        <option value="pent">Pentat√≥nica</option>
      </select>
      <button id="btnToggle">Iniciar c√°mara (Espacio)</button>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label class="legend">C√°mara</label>
        <select id="camSel"><option value="">(predeterminada)</option></select>
      </div>
      <div>
        <label class="legend">Umbral pinch (synth)</label>
        <input id="pinchThresh" type="range" min="0.15" max="0.7" step="0.01" value="0.32">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnPanic">üîá P√°nico (silencio)</button>
      <button id="btnDiag">Diagn√≥stico</button>
    </div>

    <div class="metrics">
      <div class="metric"><b>FPS</b><span id="fps">‚Äî</span></div>
      <div class="metric"><b>Latencia</b><span id="lat">‚Äî</span></div>
      <div class="metric"><b>Notas</b><span id="notes">0</span></div>
    </div>

    <p class="legend" style="margin-top:8px">
      Consejos: buena luz, manos a 40‚Äì70 cm. Atajos: <kbd>1</kbd>/<kbd>2</kbd>/<kbd>3</kbd> instrumento, <kbd>Espacio</kbd> c√°mara.
    </p>
  </div>

  <div class="overlay" aria-label="V√≠deo y overlay">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="cv"></canvas>
  </div>
</div>

<!-- MediaPipe Hands din√°mico con fallbacks -->
<script>
/* ===== Helpers y estado ===== */
const set=(id,t)=>document.getElementById(id).textContent=t;
const banner=(t)=>{const b=document.getElementById('banner');b.textContent=t;b.className='banner show';setTimeout(()=>b.className='banner',6000);}
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
const ema=(p,c,a)=>p==null?c:p+a*(c-p);
const midiToFreq=m=>440*Math.pow(2,(m-69)/12);
const xScreen = x => 1 - x; // compensar espejo para la l√≥gica
const scales={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],pent:[0,2,4,7,9]};
const quant=(m,s)=>{if(s==='free')return m;const r=60,st=Math.round(m)-r,oct=Math.floor(st/12),w=((st%12)+12)%12,al=scales[s];let best=al[0],d=99;for(const x of al){const dd=Math.abs(w-x);if(dd<d){d=dd;best=x}}return r+oct*12+best};

const FINGERS = {
  index: {tip:8, pip:6, mcp:5},
  middle:{tip:12,pip:10,mcp:9},
  ring:  {tip:16,pip:14,mcp:13},
  pinky: {tip:20,pip:18,mcp:17},
  thumb: {tip:4, pip:3, mcp:2} // lo usamos menos para piano
};

const state={
  instr:'piano',
  scale:'major',
  running:false,
  pinch:0.32,
  notes:new Map(),            // key -> {m,i}
  hands:[makeHandState(),makeHandState()], // por mano
  alpha:0.7,
  smoothed:[[],[]],
  ft:[], last:performance.now(),
  lastSeen:0
};
function makeHandState(){
  return {
    fingers:{
      index:{down:false,lastY:0,note:null},
      middle:{down:false,lastY:0,note:null},
      ring:{down:false,lastY:0,note:null},
      pinky:{down:false,lastY:0,note:null}
    }
  };
}

/* ===== Audio (Tone.js) ===== */
let audio={started:false,ctx:null,piano:null,violin:null,synth:null};
async function ensureTone(){
  if (window.Tone) return true;
  banner('No carg√≥ Tone.js (desactiva bloqueadores o prueba inc√≥gnito)'); return false;
}
async function initAudio(){
  if (audio.started) return true;
  const ok=await ensureTone(); if(!ok) return false;
  await Tone.start(); audio.ctx=Tone.context.rawContext;
  const bus=new Tone.Gain(1).toDestination();
  audio.piano=new Tone.PolySynth(Tone.Synth,{maxPolyphony:16,volume:-6,oscillator:{type:'triangle'},envelope:{attack:0.002,decay:0.08,sustain:0.6,release:0.15}}).connect(bus);
  audio.violin=new Tone.MonoSynth({oscillator:{type:'sawtooth'},portamento:0.03,envelope:{attack:0.01,decay:0.1,sustain:0.9,release:0.2}}).connect(bus);
  audio.synth=new Tone.PolySynth(Tone.DuoSynth,{maxPolyphony:12,volume:-4}).connect(bus);
  audio.started=true; return true;
}
function noteOn(key,m,vel=100,i='piano'){
  if(!audio.started) return;
  const f=midiToFreq(m);
  (i==='piano'?audio.piano:i==='synth'?audio.synth:audio.violin).triggerAttack(f, Tone.now(), vel/127);
  state.notes.set(key,{m,i});
  set('notes', state.notes.size);
}
function noteOff(key){
  if(!audio.started) return;
  const n=state.notes.get(key); if(!n) return;
  const f=midiToFreq(n.m);
  (n.i==='piano'?audio.piano:n.i==='synth'?audio.synth:audio.violin).triggerRelease(f, Tone.now()+0.001);
  state.notes.delete(key);
  set('notes', state.notes.size);
}
function panic(){ for(const [k] of state.notes) noteOff(k); }

/* ===== MediaPipe Hands ===== */
let mpBase='', HandsRef=null, mpHands=null;
async function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=()=>rej(src);document.head.appendChild(s)})}
async function ensureHands(){
  if (window.Hands){ HandsRef=window.Hands; return true; }
  const bases=['https://cdn.jsdelivr.net/npm/@mediapipe/hands','https://unpkg.com/@mediapipe/hands'];
  for (const b of bases){ try{ await loadScript(b+'/hands.min.js'); mpBase=b; HandsRef=window.Hands; return true; }catch(e){} }
  banner('MediaPipe no carg√≥ (CDN bloqueado)'); return false;
}

/* ===== C√°mara / overlay ===== */
const video=document.getElementById('video'); const cv=document.getElementById('cv'); const ctx=cv.getContext('2d');
let stream=null, raf=null;
function resize(){ const r=document.querySelector('.overlay').getBoundingClientRect(); cv.width=r.width; cv.height=r.height; }
window.addEventListener('resize', resize);

async function listCams(){ if(!navigator.mediaDevices?.enumerateDevices) return; const devs=await navigator.mediaDevices.enumerateDevices(); const cams=devs.filter(d=>d.kind==='videoinput'); const sel=document.getElementById('camSel'); sel.innerHTML='<option value="">(predeterminada)</option>'; cams.forEach(c=>{const o=document.createElement('option');o.value=c.deviceId;o.textContent=c.label||'C√°mara'; sel.appendChild(o);}); }

async function startCam(){
  const okAudio=await initAudio(); const okHands=await ensureHands(); if(!okAudio) return;
  const deviceId=document.getElementById('camSel').value;
  try{
    stream=await navigator.mediaDevices.getUserMedia({video: deviceId?{deviceId:{exact:deviceId}}:{facingMode:'user'},audio:false});
    video.srcObject=stream; await video.play(); state.running=true; resize();

    if (!mpHands && okHands && HandsRef){
      mpHands=new HandsRef({ locateFile:(f)=> (mpBase||'https://cdn.jsdelivr.net/npm/@mediapipe/hands')+'/'+f });
      mpHands.setOptions({ maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7 });
      mpHands.onResults(onResults);
    }
    const loop=async()=>{ if(!state.running) return; try{ if(mpHands) await mpHands.send({image:video}); }catch{} raf=requestAnimationFrame(loop); };
    cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
  }catch(e){ banner('C√°mara: '+e.name); }
}
function stopCam(){ try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch{} cancelAnimationFrame(raf); state.running=false; panic(); }

/* ===== Piano: l√≥gica dedo a nota ===== */
function isExtended(lm, f){ // dedo extendido vs recogido (simple: tip por encima de PIP)
  const tip=lm[FINGERS[f].tip], pip=lm[FINGERS[f].pip];
  return tip.y < pip.y - 0.01; // y hacia arriba es menor
}
function palmWidth(lm){ const a=lm[5], b=lm[17]; return Math.hypot(a.x-b.x, a.y-b.y); }
function fingerKey(handLabel, fname){ return handLabel+'_'+fname; }

/* ===== Resultados de MediaPipe ===== */
function onResults(r){
  const now=performance.now(), dt=now-state.last; state.last=now;
  state.ft.push(dt); if(state.ft.length>30) state.ft.shift();
  const avg=state.ft.reduce((a,b)=>a+b,0)/state.ft.length;
  set('fps', (1000/avg|0));
  set('lat', (((audio.ctx?.baseLatency||0)*1000 + avg*0.5)|0)+' ms');

  ctx.clearRect(0,0,cv.width,cv.height);

  const hands=r.multiHandLandmarks||[];
  const handed=r.multiHandedness||[];
  if (hands.length>0) state.lastSeen = now;

  // Dibujar teclado (banda inferior)
  const kbH=Math.min(140, cv.height*0.22);
  ctx.fillStyle='rgba(255,255,255,.07)'; ctx.fillRect(0, cv.height-kbH, cv.width, kbH);
  // cuadr√≠culas de semitonos para feedback visual
  ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.lineWidth=1;
  for(let k=0;k<24;k++){ const x=k*(cv.width/24); ctx.beginPath(); ctx.moveTo(x, cv.height-kbH); ctx.lineTo(x, cv.height); ctx.stroke();}

  for(let i=0;i<hands.length;i++){
    const lm=hands[i];
    // suavizado EMA
    if(!state.smoothed[i]||state.smoothed[i].length!==21) state.smoothed[i]=new Array(21).fill(null);
    for(let j=0;j<21;j++){
      const prev=state.smoothed[i][j], c=lm[j];
      state.smoothed[i][j]={x:ema(prev?.x,c.x,state.alpha), y:ema(prev?.y,c.y,state.alpha), z:ema(prev?.z,c.z,state.alpha)};
    }

    // etiqueta mano (ajustada a espejo)
    const label=(handed[i]?.label||'Right'); // 'Left' | 'Right'
    const isLeft = (label==='Left');
    const visLabel = isLeft ? 'R' : 'L'; // lo que ve el usuario

    // Dibuja esqueleto
    drawHand(state.smoothed[i], visLabel);

    // Mapeos por instrumento
    if (state.instr==='piano') pianoMap(i, label, kbH);
    else if (state.instr==='synth') synthMap(i);
    else if (state.instr==='violin') violinMap(i, handed);
  }

  // Auto-silencio si no hay manos desde hace >300 ms
  if (hands.length===0 && (now - state.lastSeen) > 300){
    if (state.notes.size) panic();
  }
}

function drawHand(lm, label){
  const w=cv.width,h=cv.height;
  const P=i=>({x:lm[i].x*w,y:lm[i].y*h});
  const bones=[[0,1,2,3,4],[0,5,6,7,8],[0,9,10,11,12],[0,13,14,15,16],[0,17,18,19,20]];
  ctx.lineWidth=3; ctx.strokeStyle='rgba(102,217,239,.9)';
  bones.forEach(b=>{ ctx.beginPath(); const p0=P(b[0]); ctx.moveTo(p0.x,p0.y); for(let k=1;k<b.length;k++){ const p=P(b[k]); ctx.lineTo(p.x,p.y);} ctx.stroke(); });
  ctx.fillStyle='#a6e22e'; for(let i=0;i<21;i++){ const p=P(i); ctx.beginPath(); ctx.arc(p.x,p.y,3,0,7); ctx.fill(); }
  // etiqueta L/R
  ctx.fillStyle='rgba(14,21,34,.9)'; ctx.strokeStyle='#1e2a3e'; ctx.lineWidth=2;
  const wri=P(0); ctx.strokeRect(wri.x-10,wri.y-28,28,20); ctx.fillRect(wri.x-10,wri.y-28,28,20);
  ctx.fillStyle='#b9c7da'; ctx.fillText(label, wri.x-2, wri.y-14);
}

/* ===== Piano mapping con dedos independientes ===== */
function pianoMap(handIdx, label, kbH){
  const lm=state.smoothed[handIdx]; if(!lm) return;
  const hand = state.hands[handIdx];
  const strikeY = 1 - (kbH/cv.height) + 0.10*(kbH/cv.height); // umbral de ataque
  const releaseY = strikeY - 0.05; // histeresis

  for (const fname of ['index','middle','ring','pinky']){
    const tip = lm[FINGERS[fname].tip];
    const tipX = xScreen(tip.x), tipY = tip.y;
    const fstate = hand.fingers[fname];
    // velocidad vertical (down > 0)
    const vDown = Math.max(0, tipY - (fstate.lastY||tipY));
    fstate.lastY = tipY;

    const ext = isExtended(lm, fname);
    const touching = (tipY >= strikeY);
    const releasing = (tipY < releaseY) || !ext;

    const keyId = fingerKey(label, fname);

    // NOTE ON: dedo extendido, entra en zona teclado y estaba arriba
    if (ext && touching && !fstate.down){
      fstate.down = true;
      // mapea X a 2 octavas [48..72)
      let midi = Math.floor(clamp(tipX,0,1)*(72-48)) + 48;
      if (state.scale!=='free') midi = quant(midi, state.scale);
      // velocity a partir de vDown (amplificada)
      const vel = clamp(Math.round((vDown*900) + 40), 10, 127);
      noteOn(keyId, midi, vel, 'piano');
      fstate.note = midi;
    }

    // NOTE OFF: sube por encima de release o recoge el dedo
    if (fstate.down && releasing){
      fstate.down = false;
      noteOff(keyId);
      fstate.note = null;
    }
  }
}

/* ===== Synth (pinch robusto por palma) ===== */
function synthMap(handIdx){
  const lm=state.smoothed[handIdx]; if(!lm) return;
  const keyId='s_'+handIdx;
  const palm = Math.max(0.08, palmWidth(lm));
  const pinch = Math.hypot(lm[8].x-lm[4].x, lm[8].y-lm[4].y)/palm;
  const x = clamp(xScreen(lm[8].x),0,1);
  let midi = Math.round(48 + x*24);
  if (state.scale!=='free') midi = quant(midi, state.scale);
  const vel = clamp(Math.round((1-clamp((pinch-0.1)/0.6,0,1))*127),1,127);
  if (pinch < state.pinch && !state.notes.has(keyId)) noteOn(keyId, midi, vel, 'synth');
  else if (pinch >= state.pinch && state.notes.has(keyId)) noteOff(keyId);
}

/* ===== Viol√≠n (gliss continuo + auto-silencio ya global) ===== */
function violinMap(handIdx, handed){
  const lm=state.smoothed[handIdx]; if(!lm) return;
  const label=(handed[handIdx]?.label||'Right');
  const isLeft = (label==='Left');
  // si hay 1 sola mano o es la izquierda ‚Üí tono
  if (isLeft || handed.length===1){
    const keyId='v';
    const y=clamp(lm[8].y,0,1);
    const m = 48 + (1-y)*36;
    if (!state.notes.has(keyId)) noteOn(keyId, Math.round(m), 100, 'violin');
    else audio.violin.frequency.setValueAtTime(midiToFreq(m), Tone.now());
  }
}

/* ===== UI ===== */
const btnToggle=document.getElementById('btnToggle');
document.getElementById('btnPiano').onclick=()=>state.instr='piano';
document.getElementById('btnViolin').onclick=()=>state.instr='violin';
document.getElementById('btnSynth').onclick=()=>state.instr='synth';
document.getElementById('scaleSel').onchange=(e)=> state.scale=e.target.value;
document.getElementById('pinchThresh').oninput=(e)=> state.pinch=parseFloat(e.target.value);
document.getElementById('btnPanic').onclick=panic;
document.getElementById('btnDiag').onclick=async()=>{
  try{ const id=document.getElementById('camSel').value;
    const s=await navigator.mediaDevices.getUserMedia({video:id?{deviceId:{exact:id}}:true}); s.getTracks().forEach(t=>t.stop());
    banner('Diagn√≥stico OK: c√°mara accesible'); }catch(e){ banner('Diagn√≥stico: '+e.name); }
};
document.getElementById('camSel').onchange=()=>{ if(state.running){ stopCam(); startCam(); } };
window.addEventListener('keydown', async (e)=>{
  if (e.code==='Digit1') state.instr='piano';
  if (e.code==='Digit2') state.instr='violin';
  if (e.code==='Digit3') state.instr='synth';
  if (e.code==='Space'){ e.preventDefault(); if(!state.running){ await startCam(); btnToggle.textContent='Detener c√°mara'; } else { stopCam(); btnToggle.textContent='Iniciar c√°mara'; } }
});
window.addEventListener('visibilitychange', ()=>{ if(document.hidden) panic(); });

/* ===== Boot ===== */
(async function boot(){
  resize(); listCams();
  const handsOK = await ensureHands();
  if(!handsOK) console.warn('MediaPipe no carg√≥; se ver√° v√≠deo pero sin tracking.');
})();
</script>
</body>
</html>
